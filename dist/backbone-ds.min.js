!function(e){var n=function(n){function t(e,n){var t,r=f[e].idAttribute;a[e]=a[e]||{},_.isArray(n)?n.forEach(function(n){var t=n[r];a[e][t]=!0}):(t=n[r],a[e][t]=!0)}function r(e,n){return a[e]?a[e][n]:!1}function o(e){return f[e].collection?!1:!0}function i(e){var n=new $.Deferred,t=this.get(e);return s[e]?n.resolve(t):t.fetch().then(function(){s[e]=!0,n.resolve(t)}),n.promise()}function c(e,n){var t,o,i,c={},l=$.Deferred();return i=this.get(e,n),t=f[e].idAttribute,i?r(e,n)?i.fetch().then(function(){return delete a[e][n],i}):(l.resolve(i),l.promise()):(c[t]=n,o=new f[e].model(c),o.fetch().then(function(){return u.inject(e,o),o},function(){throw new Error("error fetching model: "+n)}))}var u=new n.Model,f={},l={},a={},d={},s={};return u.defineResource=function(e){if(!e.hasOwnProperty("name")||!e.name)throw new Error("name must be specified when defining a resource");if((!e.hasOwnProperty("idAttribute")||!e.idAttribute)&&e.collection)throw new Error("idAttribute must be specified when defining a resource");if(f[e.name])throw new Error(e.name+" resource has already been defined!");return!e.model&&e.collection&&(e.model=e.collection.prototype.model),e.hasOwnProperty("idAttribute")&&!e.hasOwnProperty("collection")&&(e.collection=n.Collection),f[e.name]=e,l[e.name]||(e.collection?l[e.name]=new e.collection:(e.model=e.model||n.Model,l[e.name]=new e.model)),this},u.createInstance=function(e){return new f[e].model},u.inject=function(e,r,o){var i,c;return l[e]instanceof n.Collection?(o=_.extend({incomplete:!1},o),i=l[e],o.incomplete&&t(e,r),i.add(r)):(c=l[e],c.set(r))},u.get=function(e,n){var t,r,i,c={};return arguments[0]in this.attributes?this.attributes[arguments[0]]:o(e)?l[e]:(i=f[e].idAttribute,r=l[e],r&&(c[i]=n,t=r.findWhere(c))?t:null)},u.getAll=function(e){return l[e]},u.ejectAll=function(e){var n=l[e];n&&n.reset()},u.find=function(e,n){return o(e)?i.call(this,e):c.call(this,e,n)},u.findAll=function(e,n){var t=l[e],r=$.Deferred();return d.hasOwnProperty(e)?(r.resolve(t),r.promise()):t.fetch().then(function(r){return u.inject(e,r,n),d[e]="completed",t},function(){throw new Error("error fetching collection: "+e)})},u.where=function(e,n){var t=l[e],r=f[e].collection,o=new r,i=t.where(n);return o.add(i),o},u.filter=function(e,n){var t=l[e],r=f[e].collection,o=new r,i=t.filter(n);return o.add(i),o},u.update=function(e,n,t){var r=this.get(e,n);return r.set(t),r.save().then(function(){return r})},u.create=function(e,n){f[e].idAttribute;return n.save().then(function(){return l[e].add(n),n})},u.destroy=function(e,n){var t=this.get(e,n);return t.destroy()},u.reset=function(){return l={},f={},a={},d={},s={},this},e.DS=u,u};"function"==typeof define&&define.amd?define(["backbone"],function(e){return n(e)}):n(e.Backbone)}(window);